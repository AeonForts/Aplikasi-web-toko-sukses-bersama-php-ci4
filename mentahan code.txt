<!-- Add/Edit Penjualan Modal -->
<div class="modal fade" id="ModalPenjualan" tabindex="-1" role="dialog" aria-labelledby="ModalPenjualanLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document"> <!-- Increased modal size -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ModalPenjualanLabel">Tambah/Edit Penjualan</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="penjualanForm">
                    <div class="row">
                        <div class="col-md-6"> <!-- Left side for input fields -->
                            <input type="hidden" id="id_penjualan" name="id_penjualan">
                            <div class="form-group">
                                <label for="nama_customer">Nama Customer</label>
                                <input type="text" name="nama_customer" class="form-control" id="nama_customer" required>
                            </div>
                            <div class="form-group row">
                                <div class="col-md-6">
                                    <label for="id_tipe">Tipe Barang</label>
                                    <select name="id_tipe" id="id_tipe" class="form-control" required>
                                        <option value="">Pilih Tipe Barang</option>
                                        <?php foreach ($tipeBarangList as $tipe) : ?>
                                            <option value="<?= $tipe['id_tipe']; ?>" data-satuan="<?= $tipe['satuan_barang']; ?>" data-harga="<?= $tipe['standar_harga_jual']; ?>"><?= $tipe['jenis_barang']; ?></option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="satuan_barang">Satuan Barang</label>
                                    <input type="text" name="satuan_barang" id="satuan_barang" class="form-control" placeholder="Satuan Barang" readonly>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="harga_jual">Harga Jual Barang</label>
                                <input type="text" name="harga_jual" class="form-control" id="harga_jual" required>
                            </div>
                        <div class="form-group">
                            <label for="jumlah">Uang</label>
                            <input type="number" name="jumlah" class="form-control" id="jumlah" required>
                        </div>

                            <div class="form-group">
                                <label for="jumlah_keluar">Barang Keluar</label>
                                <input type="number" name="jumlah_keluar" class="form-control" id="jumlah_keluar" required readonly>
                            </div>
                            <div class="form-group">
                                <label for="keterangan">Keterangan</label>
                                <input type="text" name="keterangan" class="form-control" id="keterangan">
                            </div>
                            <div class="form-group">
                                <label for="id_method">Metode Pembayaran</label>
                                <select name="id_method" id="id_method" class="form-control" required>
                                    <option value="3">Cash</option>
                                    <option value="1">Piutang</option>
                                    <option value="2">Transfer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button type="button" id="addToCart" class="btn btn-primary">Add to Cart</button>
                            </div>
                        </div>
                        <div class="col-md-6"> <!-- Right side for cart -->
                            <h5>Cart</h5>
                            <table class="table" id="cartTable">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Cart items will be appended here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" id="insertAll" class="btn btn-success">Insert All</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="ModalSuccess" tabindex="-1" role="dialog" aria-labelledby="ModalSuccessLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ModalSuccessLabel">Success</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="successMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Failure Modal -->
<div class="modal fade" id="ModalFailure" tabindex="-1" role="dialog" aria-labelledby="ModalFailureLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ModalFailureLabel">Error</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="errorMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="DeleteConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="DeleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="DeleteConfirmationModalLabel">Confirm Deletion</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this penjualan?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Function to show toast
    function showToast(icon, title) {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        })

        Toast.fire({
            icon: icon,
            title: title
        })
    }

    // Function to show alert, then reload, and set toast message
    function showAlertThenReload(alertOptions, toastOptions) {
        Swal.fire(alertOptions).then((result) => {
            if (result.isConfirmed) {
                $('.modal').modal('hide'); // Close all Bootstrap modals
                // Store toast message in sessionStorage
                sessionStorage.setItem('toastMessage', JSON.stringify(toastOptions));
                location.reload(); // Reload the page
            }
        });
    }

    // Check for toast message on page load
    var storedToastMessage = sessionStorage.getItem('toastMessage');
    if (storedToastMessage) {
        var toastOptions = JSON.parse(storedToastMessage);
        showToast(toastOptions.icon, toastOptions.title);
        sessionStorage.removeItem('toastMessage'); // Clear the message
    }

    // Load Tipe Barang options
    loadTipeBarang();

    // Handle form submission for adding penjualan
    $('#penjualanForm').on('submit', function(event) {
        event.preventDefault();
        $.ajax({
            url: '<?= base_url('admin/penjualan/save'); ?>',
            type: 'POST',
            data: $(this).serialize() + '&save=true',
            dataType: 'json',
            success: function(response) {
                if (response.status === 'success') {
                    $('#ModalPenjualan').modal('hide');
                    $('#penjualanForm')[0].reset();
                    showAlertThenReload(
                        {
                            icon: 'success',
                            title: 'Berhasil!',
                            text: response.message || 'Penjualan berhasil ditambahkan',
                        },
                        {
                            icon: 'success',
                            title: 'Penjualan berhasil ditambahkan'
                        }
                    );
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: response.message || 'Terjadi kesalahan saat menyimpan data.',
                    });
                }
            },
            error: function(xhr, status, error) {
                let errorMessage = "Terjadi kesalahan: " + error;
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: errorMessage,
                });
            }
        });
    });

    // Handle Tipe Barang change
    $('#id_tipe').on('change', function() {
        var selectedId = $(this).val();
        if (selectedId) {
            $.ajax({
                url: '<?= base_url('admin/penjualan/getTipeBarang') ?>',
                type: 'GET',
                dataType: 'json',
                success: function(data) {
                    var selectedItem = data.find(item => item.id == selectedId);
                    if (selectedItem) {
                        $('#satuan_barang').val(selectedItem.satuan_barang);
                        $('#harga_jual').val(selectedItem.standar_harga_jual);
                    } else {
                        $('#satuan_barang').val('');
                        $('#harga_jual').val('');
                    }
                },
                error: function() {
                    console.error('Error fetching tipe barang data');
                }
            });
        } else {
            $('#satuan_barang').val('');
            $('#harga_jual').val('');
        }
    });

    // Populate the select options on page load
    $.ajax({
        url: '<?= base_url('admin/penjualan/getTipeBarang') ?>',
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            var select = $('#id_tipe');
            select.empty();
            select.append('<option value="">Pilih Tipe Barang</option>');
            $.each(data, function(index, item) {
                select.append('<option value="' + item.id + '">' + item.jenis_barang + '</option>');
            });
        },
        error: function() {
            console.error('Error fetching tipe barang data');
        }
    });

    // Update button click
    $('#submitUpdate').click(function() {
        var formData = $('#updateForm').serialize();
        $.ajax({
            url: '<?= base_url('admin/penjualan/updateTerkumpul'); ?>',
            type: 'POST',
            data: formData,
            success: function(response) {
                if(response.success) {
                    $('#updateModal').modal('hide');
                    showAlertThenReload(
                        {
                            icon: 'success',
                            title: 'Berhasil!',
                            text: 'Record berhasil diperbarui',
                        },
                        {
                            icon: 'success',
                            title: 'Record berhasil diperbarui'
                        }
                    );
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: response.message,
                    });
                }
            },
            error: function(xhr, status, error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error!',
                    text: "An error occurred: " + error,
                });
            }
        });
    });

    // Function to calculate Barang Keluar
    function calculateBarangKeluar() {
        var uang = parseFloat($('#jumlah').val()) || 0; // Get Uang
        var hargaJual = parseFloat($('#harga_jual').val()) || 0; // Get Harga Jual
        var barangKeluar = hargaJual > 0 ? (uang / hargaJual) : 0; // Calculate Barang Keluar
        $('#jumlah_keluar').val(barangKeluar.toFixed(2)); // Display Barang Keluar
    }

    // Event listeners for calculating Barang Keluar
    $('#jumlah, #harga_jual').on('input', calculateBarangKeluar); // Trigger calculation on input change

    // Load Tipe Barang function
    function loadTipeBarang() {
        $.ajax({
            url: '<?= base_url('admin/penjualan/getTipeBarang'); ?>',
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                if (response.error) {
                    console.log('Error: ' + response.error);
                } else {
                    $.each(response, function(key, value) {
                        $('#id_tipe').append('<option value="' + key + '">' + value + '</option>');
                    });
                }
            },
            error: function(xhr, status, error) {
                console.error("AJAX Error: ", error);
            }
        });
    }

    // Function to add item to cart
    $('#addToCart').on('click', function() {
    var itemName = $('#id_tipe option:selected').text(); // Get item name
    var idTipe = $('#id_tipe').val(); // Get id_tipe
    var quantity = $('#jumlah_keluar').val();
    var price = $('#harga_jual').val();
    
    if (itemName && idTipe && quantity && price) { // Ensure idTipe is checked
        var cartRow = `<tr data-id-tipe="${idTipe}"> <!-- Store id_tipe as a data attribute -->
            <td>${itemName}</td>
            <td>${quantity}</td>
            <td>${price}</td>
            <td><button type="button" class="btn btn-danger removeItem">Remove</button></td>
        </tr>`;
        $('#cartTable tbody').append(cartRow);
        clearInputFields();
    } else {
        alert('Please fill in all fields before adding to cart.');
    }
});


    // Function to clear input fields
    function clearInputFields() {
        $('#id_tipe').val('');
        $('#satuan_barang').val('');
        $('#harga_jual').val('');
        $('#jumlah').val('');
        $('#jumlah_keluar').val('');
        $('#keterangan').val('');
    }

    // Function to remove item from cart
    $('#cartTable').on('click', '.removeItem', function() {
        $(this).closest('tr').remove();
    });

    // Function to insert all items from cart
// Function to insert all items from cart with SweetAlert confirmation
$('#insertAll').on('click', function() {
    var cartData = [];
    $('#cartTable tbody tr').each(function() {
        var item = {
            id_tipe: $(this).data('id-tipe'), // Get id_tipe from the data attribute
            name: $(this).find('td:eq(0)').text(),
            quantity: $(this).find('td:eq(1)').text(),
            price: $(this).find('td:eq(2)').text()
        };
        cartData.push(item);
    });

    // Check if the cart is empty
    if (cartData.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Cart is Empty',
            text: 'Please add items to the cart before inserting.',
        });
        return; // Prevent further execution if cart is empty
    }

    // Get the id_method from the form
    var idMethod = $('#id_method').val(); // Capture the id_method

    // SweetAlert confirmation dialog
    Swal.fire({
        title: 'Are you sure?',
        text: "Do you want to insert all items from the cart?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, insert all!',
        cancelButtonText: 'No, cancel!'
    }).then((result) => {
        if (result.isConfirmed) {
            // If confirmed, send cartData and id_method to the server
            $.ajax({
                url: '<?= base_url('admin/penjualan/save'); ?>',
                type: 'POST',
                data: { cart: cartData, id_method: idMethod }, // Include id_method in the data
                success: function(response) {
                    if (response.status === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Success',
                            text: 'All items inserted successfully!',
                        }).then(() => {
                            // Clear cart and close the modal after success
                            $('#ModalPenjualan').modal('hide');
                            $('#cartTable tbody').empty(); // Clear cart after successful insert
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error inserting items: ' + response.message,
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'An error occurred while inserting items.',
                    });
                }
            });
        }
    });
});


});
</script>


<?php

namespace App\Controllers\Admin;

use App\Controllers\BaseController;
use App\Models\{PenjualanModel, DetailPembelianModel, DetailPenjualanModel, ViewDetailPenjualanModel, BarangModel, CustomerModel,PaymentModel, PaymentMethodModel};
use CodeIgniter\HTTP\ResponseInterface;
use Exception;

class PenjualanController extends BaseController
{
    private $db;
    private $penjualanModel;
    private $customerModel;
    private $detailPembelianModel;
    private $detailPenjualanModel;
    private $viewDetailPenjualanModel;
    private $paymentModel;
    private $paymentMethodModel;
    private $barangModel;

    public function __construct()
    {
        $this->db = \Config\Database::connect();
        $this->penjualanModel = new PenjualanModel();
        $this->customerModel = new CustomerModel();
        $this->detailPembelianModel = new DetailPembelianModel();
        $this->detailPenjualanModel = new DetailPenjualanModel();
        $this->viewDetailPenjualanModel = new ViewDetailPenjualanModel();
        $this->paymentModel = new PaymentModel();
        $this->paymentMethodModel = new PaymentMethodModel();
        $this->barangModel = new BarangModel();
    }

    public function list()
    {
        $data = [
            'penjualan' => $this->penjualanModel->paginate(10),
            'pager' => $this->penjualanModel->pager,
            'tipeBarangList' => $this->barangModel->findAll()
        ];

        return view('pages/admin/penjualan/list', $data);
    }

    public function detail($id)
    {
        $data['vw_detail_penjualan'] = $this->viewDetailPenjualanModel->getDetailByPenjualanId($id);
        return view('pages/admin/penjualan/detail', $data);
    }

    public function save()
    {
        $this->db->transStart();
        
        try {
            // Check if cart data is provided
            if ($this->request->getPost('cart')) {
                $cartItems = $this->request->getPost('cart');
                foreach ($cartItems as $item) {
                    // Ensure id_tipe is being set correctly
                    $input = [
                        'nama_customer' => $this->request->getPost('nama_customer'),
                        'id_tipe' => $item['id_tipe'], // Ensure this is set correctly
                        'jumlah_keluar' => $item['quantity'],
                        'harga_jual' => $item['price'],
                        'jumlah' => $this->request->getPost('jumlah'),
                        'keterangan' => $this->request->getPost('keterangan'),
                        'id_method' => $this->request->getPost('id_method')
                    ];

                    log_message('debug', 'POST data: ' . json_encode($this->request->getPost()));

                    // Log the input for debugging

                    $customer = $this->getOrCreateCustomer($input['nama_customer']);
                    $pembelian = $this->getLatestPembelian($input['id_tipe']);
                    
                    $totals = $this->calculateTotals($input['jumlah_keluar'], $input['harga_jual'], $pembelian['harga_modal_barang']);
                    $id_penjualan = $this->updateOrCreatePenjualan($input['id_tipe'], $input['jumlah_keluar'], $totals);
                    
                    $this->insertDetailPenjualan($id_penjualan, $customer['id_customer'], $input, $pembelian['id_pembelian']);
                }
            } else {
                // Existing save logic for single item
                $input = $this->validateInput();
                $customer = $this->getOrCreateCustomer($input['nama_customer']);
                $pembelian = $this->getLatestPembelian($input['id_tipe']);
                
                $totals = $this->calculateTotals($input['jumlah_keluar'], $input['harga_jual'], $pembelian['harga_modal_barang']);
                $id_penjualan = $this->updateOrCreatePenjualan($input['id_tipe'], $input['jumlah_keluar'], $totals);
                
                $this->insertDetailPenjualan($id_penjualan, $customer['id_customer'], $input, $pembelian['id_pembelian']);
            }

            $this->db->transComplete();
            return $this->successResponse();
        } catch (Exception $e) {
            $this->db->transRollback();
            return $this->errorResponse($e->getMessage());
        }
    }
    
    public function getTipeBarang()
    {
        $barangModel = new BarangModel();
        $data = $barangModel->findAll();
        $options = [];
        
        foreach ($data as $item) {
            $options[] = [
                'id' => (int) $item['id_tipe'],
                'jenis_barang' => $item['jenis_barang'],
                'satuan_barang' => $item['satuan_barang'],
                'standar_harga_jual' => $item['standar_harga_jual']
            ];
        }
        
        // Ensure to return an empty array instead of an error message if no data is found
        return $this->response->setJSON($options);
    }

    private function validateInput()
    {
        $input = $this->request->getPost([
            'nama_customer', 'id_tipe', 'jumlah_keluar', 'harga_jual', 'keterangan', 'id_method','jumlah' // Added id_method
        ]);

        if (empty($input['nama_customer']) || empty($input['id_tipe']) || empty($input['jumlah_keluar']) || empty($input['id_method']) || empty($input['jumlah'])) {
            throw new Exception("Customer name, product type, quantity, payment method, and total amount (jumlah) are required.");
        }
        

        return $input;
    }

    private function getOrCreateCustomer($nama_customer)
    {
        $customer = $this->customerModel->where('nama_customer', $nama_customer)->first();
        if (!$customer) {
            $this->customerModel->insert(['nama_customer' => $nama_customer]);
            $customer = ['id_customer' => $this->customerModel->getInsertID()];
        }
        return $customer;
    }

    private function getLatestPembelian($id_tipe)
    {
        // Debugging: Log the id_tipe being processed
        log_message('debug', 'Processing id_tipe: ' . $id_tipe);

        $pembelian = $this->detailPembelianModel
            ->join('tbl_pembelian tp', 'tbl_detail_pembelian.id_pembelian = tp.id_pembelian')
            ->where('id_tipe', $id_tipe)
            ->orderBy('tp.tgl_masuk', 'DESC')
            ->first();

        // Check if the query returned false
        if ($pembelian === false) {
            throw new Exception("Query failed: No stock available for this item type or invalid query.");
        }

        if (!$pembelian) {
            throw new Exception("No stock available for this item type.");
        }

        return $pembelian;
    }

    private function calculateTotals($jumlah_keluar, $harga_jual, $harga_modal_barang)
    {
        $total_harga_jual = $harga_jual * $jumlah_keluar;
        $total_harga_modal = $harga_modal_barang * $jumlah_keluar;
        return [
            'total_harga_jual' => $total_harga_jual,
            'total_harga_modal' => $total_harga_modal,
            'total_untung' => $total_harga_jual - $total_harga_modal
        ];
    }

    private function updateOrCreatePenjualan($id_tipe, $jumlah_keluar, $totals)
    {
        // Calculate the cumulative total_barang_keluar
        // $total_barang_keluar = $this->calculateTotalBarangKeluar($id_tipe) + $jumlah_keluar;

        // Assuming you have a PenjualanModel for handling penjualan records
        $penjualanData = [
            'tgl_penjualan' => date('Y-m-d'),
            'id_tipe' => $id_tipe,
            // 'jumlah_keluar' => $jumlah_keluar,
            'total_harga_jual' => $totals['total_harga_jual'],
            'total_harga_modal' => $totals['total_harga_modal'],
            'total_untung' => $totals['total_untung'],
            // 'total_barang_keluar' => $total_barang_keluar // Include the cumulative total
            // Add other necessary fields here
        ];

        // Insert the record and get the ID
        $id_penjualan = $this->penjualanModel->insert($penjualanData);

        // Check if the insertion was successful
        if (!$id_penjualan) {
            throw new Exception("Failed to create penjualan record.");
        }

        // Return the ID of the newly created record
        return $this->penjualanModel->getInsertID();
    }



    private function insertDetailPenjualan($id_penjualan, $id_customer, $input, $id_pembelian)
    {
        // Insert payment record
        $id_payment = $this->insertPayment($input['jumlah'], $input['id_method'], $id_customer, $id_penjualan); 
        log_message('debug', 'Calling insertPayment with jumlah: ' . $input['jumlah']);

        $this->detailPenjualanModel->insert([
            'id_customer' => $id_customer,
            'id_penjualan' => $id_penjualan,
            'jumlah_keluar' => $input['jumlah_keluar'],
            'harga_jual' => $input['harga_jual'],
            'keterangan' => $input['keterangan'],
            'id_pembelian' => $id_pembelian,
            'id_tipe' => $input['id_tipe'],
            'id_payment' => $id_payment // Include payment ID
        ]);
    }

    private function insertPayment($jumlah, $id_method, $id_customer, $id_penjualan)
    {
        log_message('debug', 'Inserting payment with jumlah: ' . $jumlah);

        $this->paymentModel->insert([
            'id_customer' => $id_customer, // Now this variable is available
            'id_method' => $id_method,
            'tgl' => date('Y-m-d'),
            'jumlah' => $jumlah
        ]);
        return $this->paymentModel->getInsertID();
    }

    private function successResponse()
    {
        return $this->response->setJSON([
            'status' => 'success',  // Ensure 'status' is present
            'message' => 'Transaction successfully recorded.'
        ]);
    }
    

    private function errorResponse($message)
    {
        return $this->response->setJSON([
            'status' => 'error',  // Ensure 'status' is present
            'message' => $message
        ]);
    }
    
}
